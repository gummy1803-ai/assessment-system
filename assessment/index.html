<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† å¹²éƒ¨è€ƒæ ¸ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', sans-serif;
            background-image: url('èƒŒæ™¯å›¾.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
            color: white;
            transition: all 0.3s ease;
        }

        .tab-btn.active, .tab-btn:hover {
            background: white;
            color: #667eea;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            font-size: 1.3em;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .score-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .score-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .score-item h3 {
            font-size: 3em;
            margin: 10px 0;
        }

        .score-item .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .total-score {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            margin: 2px;
        }

        .btn-add {
            background: #28a745;
            color: white;
        }

        .btn-add:hover {
            background: #218838;
        }

        .btn-sub {
            background: #dc3545;
            color: white;
        }

        .btn-sub:hover {
            background: #c82333;
        }

        .btn-edit {
            background: #007bff;
            color: white;
        }

        .btn-delete {
            background: #6c757d;
            color: white;
        }

        .btn-view {
            background: #17a2b8;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .btn-submit:hover {
            transform: scale(1.05);
        }

        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }

        .status-excellent {
            background: #d4edda;
            color: #155724;
        }

        .status-good {
            background: #cce5ff;
            color: #004085;
        }

        .status-average {
            background: #fff3cd;
            color: #856404;
        }

        .status-poor {
            background: #f8d7da;
            color: #721c24;
        }

        .search-box {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            border-radius: 15px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .detail-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .detail-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .record-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .record-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .record-item:last-child {
            border-bottom: none;
        }

        .score-change {
            font-weight: bold;
        }

        .score-plus {
            color: #28a745;
        }

        .score-minus {
            color: #dc3545;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #f0f0ff;
        }

        .upload-area p {
            color: #667eea;
            font-size: 18px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-item h3 {
            font-size: 2em;
            margin: 10px 0;
        }

        .collapsible-section {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .collapsible-header {
            padding: 12px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            transition: opacity 0.3s;
        }

        .collapsible-header:hover {
            opacity: 0.9;
        }

        .collapsible-arrow {
            transition: transform 0.3s;
            font-size: 12px;
        }

        .collapsible-section.active .collapsible-arrow {
            transform: rotate(-180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: #f9f9f9;
        }

        .collapsible-section.active .collapsible-content {
            max-height: 500px;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ† å¹²éƒ¨è€ƒæ ¸ç®¡ç†ç³»ç»Ÿ</h1>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div class="tabs">
            <button class="tab-btn active" onclick="showTab('overview')">ğŸ“Š æ€»è§ˆ</button>
            <button class="tab-btn" onclick="showTab('cadres')">ğŸ‘¥ å¹²éƒ¨ç®¡ç†</button>
            <button class="tab-btn" onclick="showTab('competition')">ğŸ† æ¯”èµ›æˆç»©</button>
            <button class="tab-btn" onclick="showTab('contribution')">ğŸ¤ åä¼šè´¡çŒ®</button>
            <button class="tab-btn" onclick="showTab('equipment')">ğŸ”§ è®¾å¤‡æŒæ§</button>
            <button class="tab-btn" onclick="showTab('training')">ğŸ‘¨â€ğŸ« æ–°ç”ŸæŒ‡å¯¼</button>
            <button class="tab-btn" onclick="showTab('deduction')">âš ï¸ èŒè´£æ‰£åˆ†</button>
            </div>
            
            <!-- æ¨¡å¼åˆ‡æ¢å’Œå¯†ç æ§åˆ¶ -->
            <div id="modeControls" style="display: flex; gap: 15px; align-items: center;">
                <div id="modeIndicator" style="font-weight: bold; color: #28a745;">æŸ¥çœ‹æ¨¡å¼</div>
                <button id="switchModeBtn" class="tab-btn" onclick="promptPassword()">åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼</button>
                <button id="changePasswordBtn" class="tab-btn" style="background: #17a2b8;" onclick="showChangePasswordModal()">ä¿®æ”¹å¯†ç </button>
                <button id="clearDataBtn" class="tab-btn" style="background: #dc3545;" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
                <button id="githubSettingsBtn" class="tab-btn" style="background: #333; color: white;" onclick="showGithubSettings()">âš™ï¸ GitHubè®¾ç½®</button>
            </div>
        </div>

        <!-- æ€»è§ˆé¡µé¢ -->
        <div id="overview" class="tab-content active">
            <h2>ğŸ“Š è€ƒæ ¸æ€»è§ˆ</h2>
            <div class="dashboard">
                <div class="card">
                    <h2>ğŸ“ˆ é›·è¾¾å›¾å¯¹æ¯”</h2>
                    
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <span>ğŸ‘¥ å¹²éƒ¨é€‰æ‹©</span>
                            <span class="collapsible-arrow">â–¼</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="form-group" style="margin-bottom: 15px;">
                                <input type="text" id="cadreSearch" placeholder="ğŸ” æœç´¢å¹²éƒ¨å§“åæˆ–éƒ¨é—¨..." oninput="filterCadreOptions()" style="margin-bottom: 10px;">
                                <div id="cadreSelection" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                                </div>
                                <div style="margin-top: 10px;">
                                    <button class="btn-submit" onclick="compareSelectedCadres()" style="padding: 10px 20px;">ğŸ“Š ç”Ÿæˆå¯¹æ¯”å›¾</button>
                                    <button class="btn-submit" onclick="clearChartSelection()" style="padding: 10px 20px; background: #6c757d;">ğŸ—‘ï¸ æ¸…é™¤é€‰æ‹©</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                    <div id="chartPlaceholder" style="text-align: center; padding: 50px; color: #666;">
                        <p style="font-size: 18px;">è¯·é€‰æ‹©å¹²éƒ¨æŸ¥çœ‹é›·è¾¾å›¾</p>
                        <p style="font-size: 14px; margin-top: 10px;">å¯é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªå¹²éƒ¨è¿›è¡Œå¯¹æ¯”</p>
                    </div>
                </div>
                <div class="card">
                    <h2>ğŸ“‹ ç»Ÿè®¡æ¦‚è§ˆ</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="label">æ€»å¹²éƒ¨æ•°</div>
                            <h3 id="totalCadres">0</h3>
                        </div>
                        <div class="stat-item">
                            <div class="label">å¹³å‡æ€»åˆ†</div>
                            <h3 id="avgScore">0</h3>
                        </div>
                        <div class="stat-item">
                            <div class="label">ä¼˜ç§€å¹²éƒ¨</div>
                            <h3 id="excellentCount">0</h3>
                        </div>
                        <div class="stat-item">
                            <div class="label">è‰¯å¥½å¹²éƒ¨</div>
                            <h3 id="goodCount">0</h3>
                        </div>
                        <div class="stat-item">
                            <div class="label">ä¸€èˆ¬å¹²éƒ¨</div>
                            <h3 id="averageCount">0</h3>
                        </div>
                        <div class="stat-item">
                            <div class="label">å¾…æ”¹è¿›</div>
                            <h3 id="poorCount">0</h3>
                        </div>
                    </div>
                </div>
            </div>
            <h3 style="margin: 20px 0;">ğŸ“Š å„ç»´åº¦å¾—åˆ†åˆ†å¸ƒ</h3>
            <div class="score-display" id="overviewScores">
            </div>
        </div>

        <!-- å¹²éƒ¨ç®¡ç†é¡µé¢ -->
        <div id="cadres" class="tab-content">
            <h2>ğŸ‘¥ å¹²éƒ¨ç®¡ç†</h2>
            <div class="form-group">
                <label>æ·»åŠ /ç¼–è¾‘å¹²éƒ¨</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                    <input type="hidden" id="cadreId">
                    <input type="text" id="cadreName" placeholder="å§“å">
                    <select id="cadreDepartment">
                        <option value="">é€‰æ‹©éƒ¨é—¨</option>
                        <option value="èµ›äº‹éƒ¨">èµ›äº‹éƒ¨</option>
                        <option value="AIéƒ¨">AIéƒ¨</option>
                        <option value="ç”µæ§éƒ¨">ç”µæ§éƒ¨</option>
                        <option value="å®‰ç›‘éƒ¨">å®‰ç›‘éƒ¨</option>
                        <option value="åŠå…¬å®¤éƒ¨">åŠå…¬å®¤éƒ¨</option>
                        <option value="é¡¹ç›®éƒ¨">é¡¹ç›®éƒ¨</option>
                        <option value="è®¾å¤‡éƒ¨">è®¾å¤‡éƒ¨</option>
                        <option value="è´¢èµ„éƒ¨">è´¢èµ„éƒ¨</option>
                        <option value="å®£ä¼ éƒ¨">å®£ä¼ éƒ¨</option>
                    </select>
                    <select id="cadrePosition">
                        <option value="">é€‰æ‹©èŒåŠ¡</option>
                        <option value="ä¼šé•¿">ä¼šé•¿</option>
                        <option value="å‰¯ä¼šé•¿">å‰¯ä¼šé•¿</option>
                        <option value="éƒ¨é•¿">éƒ¨é•¿</option>
                        <option value="å‰¯éƒ¨é•¿">å‰¯éƒ¨é•¿</option>
                        <option value="ä¼šå‘˜">ä¼šå‘˜</option>
                    </select>
                    <input type="text" id="cadreMajor" placeholder="ä¸“ä¸š">
                    <input type="text" id="cadreClass" placeholder="ç­çº§">
                    <input type="text" id="cadreGrade" placeholder="çº§æ•° (å¦‚2025çº§)">
                    <button class="btn-submit" onclick="saveCadre()">ğŸ’¾ ä¿å­˜</button>
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="searchCadre" placeholder="æœç´¢å¹²éƒ¨..." oninput="searchCadres()">
                <label for="importExcel" class="btn-submit" style="background: #17a2b8; cursor: pointer; padding: 10px 20px; display: inline-block;">ğŸ“¥ å¯¼å…¥Excel</label>
                <input type="file" id="importExcel" accept=".xlsx,.xls" style="display: none;" onchange="importExcelData(this)">
                <button class="btn-submit" style="background: #6c757d;" onclick="downloadExcelTemplate()">ğŸ“‹ ä¸‹è½½æ¨¡æ¿</button>
                <button class="btn-submit" style="background: #28a745;" onclick="exportData()">ğŸ“¤ å¯¼å‡ºCSV</button>
                <button class="btn-submit" style="background: #17a2b8;" onclick="exportCompleteData()">ğŸ“¤ å¯¼å‡ºå®Œæ•´æ•°æ®</button>
                <label for="importJson" class="btn-submit" style="background: #ffc107; cursor: pointer; padding: 10px 20px; display: inline-block;">ğŸ“¥ å¯¼å…¥JSON</label>
                <input type="file" id="importJson" accept=".json" style="display: none;" onchange="importJsonData(this)">
                <button class="btn-submit" style="background: #6f42c1;" onclick="loadFromGitHub()">ğŸŒ ä»GitHubåŠ è½½</button>
            </div>
            <table id="cadreTable">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>éƒ¨é—¨</th>
                        <th>èŒåŠ¡</th>
                        <th>ä¸“ä¸š</th>
                        <th>ç­çº§</th>
                        <th>çº§æ•°</th>
                        <th>éƒ¨é—¨èŒè´£</th>
                        <th>æ¯”èµ›æˆç»©</th>
                        <th>åä¼šè´¡çŒ®</th>
                        <th>è®¾å¤‡æŒæ§</th>
                        <th>æ–°ç”ŸæŒ‡å¯¼</th>
                        <th>æ€»åˆ†</th>
                        <th>ç­‰çº§</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="cadreTableBody">
                </tbody>
            </table>
        </div>

        <!-- æ¯”èµ›æˆç»©é¡µé¢ -->
        <div id="competition" class="tab-content">
            <h2>ğŸ† æ¯”èµ›æˆç»©å½•å…¥</h2>
            <div class="form-group">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <select id="competitionCadre">
                        <option value="">é€‰æ‹©å¹²éƒ¨</option>
                    </select>
                    <select id="competitionLevel">
                        <option value="">é€‰æ‹©æ¯”èµ›çº§åˆ«</option>
                        <option value="å›½å®¶çº§">å›½å®¶çº§</option>
                        <option value="çœçº§">çœçº§</option>
                        <option value="æ ¡çº§">æ ¡çº§</option>
                    </select>
                    <select id="competitionAward">
                        <option value="">é€‰æ‹©å¥–é¡¹</option>
                        <option value="ä¸€ç­‰å¥–">ä¸€ç­‰å¥–</option>
                        <option value="äºŒç­‰å¥–">äºŒç­‰å¥–</option>
                        <option value="ä¸‰ç­‰å¥–">ä¸‰ç­‰å¥–</option>
                    </select>
                    <input type="text" id="competitionName" placeholder="æ¯”èµ›åç§°">
                    <button class="btn-submit" onclick="addCompetition()">â• æ·»åŠ æˆç»©</button>
                </div>
            </div>
            <table id="competitionTable">
                <thead>
                    <tr>
                        <th>å¹²éƒ¨å§“å</th>
                        <th>æ¯”èµ›åç§°</th>
                        <th>çº§åˆ«</th>
                        <th>å¥–é¡¹</th>
                        <th>åŠ åˆ†</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="competitionTableBody">
                </tbody>
            </table>
        </div>

        <!-- åä¼šè´¡çŒ®é¡µé¢ -->
        <div id="contribution" class="tab-content">
            <h2>ğŸ¤ åä¼šè´¡çŒ®è®°å½•</h2>
            <div class="form-group">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <select id="contributionCadre">
                        <option value="">é€‰æ‹©å¹²éƒ¨</option>
                    </select>
                    <select id="contributionType">
                        <option value="">é€‰æ‹©è´¡çŒ®ç±»å‹</option>
                        <option value="å«ç”Ÿ">å«ç”Ÿ (+0.1åˆ†)</option>
                        <option value="æ•´ç†è®¾å¤‡">æ•´ç†è®¾å¤‡ (+0.1åˆ†)</option>
                        <option value="ç»´æŠ¤è€—æ">ç»´æŠ¤è€—æ (+0.1åˆ†)</option>
                    </select>
                    <input type="number" id="contributionCount" placeholder="æ¬¡æ•°" min="1" value="1">
                    <button class="btn-submit" onclick="addContribution()">â• æ·»åŠ è´¡çŒ®</button>
                </div>
            </div>
            <table id="contributionTable">
                <thead>
                    <tr>
                        <th>å¹²éƒ¨å§“å</th>
                        <th>è´¡çŒ®ç±»å‹</th>
                        <th>æ¬¡æ•°</th>
                        <th>ç´¯è®¡åŠ åˆ†</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="contributionTableBody">
                </tbody>
            </table>
        </div>

        <!-- è®¾å¤‡æŒæ§é¡µé¢ -->
        <div id="equipment" class="tab-content">
            <h2>ğŸ”§ è®¾å¤‡æŒæ§è¯„åˆ†å¯¼å…¥</h2>
            <div class="upload-area" onclick="document.getElementById('excelFile').click()">
                <p>ğŸ“ ç‚¹å‡»ä¸Šä¼ Excelæ–‡ä»¶</p>
                <p style="font-size: 14px;">æ”¯æŒ .xlsx, .xls æ ¼å¼</p>
                <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;" onchange="importExcel(event)">
            </div>
            <div id="importResult" style="margin: 20px 0;"></div>
            <table id="equipmentTable">
                <thead>
                    <tr>
                        <th>å¹²éƒ¨å§“å</th>
                        <th>åŸå§‹åˆ†æ•°</th>
                        <th>æ¢ç®—ååˆ†æ•°</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="equipmentTableBody">
                </tbody>
            </table>
        </div>

        <!-- æ–°ç”ŸæŒ‡å¯¼é¡µé¢ -->
        <div id="training" class="tab-content">
            <h2>ğŸ‘¨â€ğŸ« æ–°ç”ŸæŒ‡å¯¼è®°å½•</h2>
            <div class="form-group">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <select id="trainingCadre">
                        <option value="">é€‰æ‹©å¹²éƒ¨</option>
                    </select>
                    <input type="text" id="traineeName" placeholder="æ–°ç”Ÿå§“å">
                    <input type="number" id="trainingHours" placeholder="åŸ¹è®­æ—¶é•¿(å°æ—¶)" min="0.5" step="0.5">
                    <button class="btn-submit" onclick="addTraining()">â• æ·»åŠ è®°å½•</button>
                </div>
            </div>
            <table id="trainingTable">
                <thead>
                    <tr>
                        <th>å¹²éƒ¨å§“å</th>
                        <th>æ–°ç”Ÿå§“å</th>
                        <th>åŸ¹è®­æ—¶é•¿(å°æ—¶)</th>
                        <th>è·å¾—ç§¯åˆ†</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="trainingTableBody">
                </tbody>
            </table>
        </div>

        <!-- èŒè´£æ‰£åˆ†é¡µé¢ -->
        <div id="deduction" class="tab-content">
            <h2>âš ï¸ éƒ¨é—¨èŒè´£æ‰£åˆ†</h2>
            <div class="form-group">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <select id="deductionCadre">
                        <option value="">é€‰æ‹©å¹²éƒ¨</option>
                    </select>
                    <input type="number" id="deductionScore" placeholder="æ‰£åˆ†åˆ†æ•°" min="1">
                    <input type="text" id="deductionReason" placeholder="æ‰£åˆ†åŸå› ">
                    <button class="btn-submit" onclick="addDeduction()">â– è®°å½•æ‰£åˆ†</button>
                </div>
            </div>
            <table id="deductionTable">
                <thead>
                    <tr>
                        <th>å¹²éƒ¨å§“å</th>
                        <th>æ‰£åˆ†åŸå› </th>
                        <th>æ‰£åˆ†</th>
                        <th>å‰©ä½™åˆ†æ•°</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="deductionTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">å¹²éƒ¨è¯¦æƒ…</h2>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- å¯†ç ä¿®æ”¹å¼¹çª— -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChangePasswordModal()">&times;</span>
            <h2>ä¿®æ”¹å¯†ç </h2>
            <div class="form-group">
                <label for="currentPassword">å½“å‰å¯†ç </label>
                <input type="password" id="currentPassword" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " required>
            </div>
            <div class="form-group">
                <label for="newPassword">æ–°å¯†ç </label>
                <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç " required>
            </div>
            <div class="form-group">
                <label for="confirmPassword">ç¡®è®¤æ–°å¯†ç </label>
                <input type="password" id="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required>
            </div>
            <button class="btn-submit" onclick="changePassword()">ç¡®è®¤ä¿®æ”¹</button>
        </div>
    </div>

    <!-- GitHubè®¾ç½®å¼¹çª— -->
    <div id="githubSettingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGithubSettingsModal()">&times;</span>
            <h2>âš™ï¸ GitHubè®¾ç½®</h2>
            <div class="form-group">
                <label for="githubUrl">GitHubä»“åº“JSONæ–‡ä»¶URL</label>
                <input type="text" id="githubUrl" placeholder="ä¾‹å¦‚ï¼šhttps://raw.githubusercontent.com/username/repo/main/å¹²éƒ¨è€ƒæ ¸å®Œæ•´æ•°æ®.json" style="width: 100%;">
            </div>
            <div class="form-group">
                <label for="autoLoadGithub">
                    <input type="checkbox" id="autoLoadGithub"> å¯åŠ¨æ—¶è‡ªåŠ¨ä»GitHubåŠ è½½æ•°æ®
                </label>
            </div>
            <div class="form-group">
                <label for="autoSyncGithub">
                    <input type="checkbox" id="autoSyncGithub"> å®šæœŸè‡ªåŠ¨åŒæ­¥GitHubæ•°æ® (æ¯5åˆ†é’Ÿ)
                </label>
            </div>
            <button class="btn-submit" onclick="saveGithubSettings()">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <script>
        // æœåŠ¡å™¨é…ç½®
        const SERVER_URL = 'http://192.168.1.19:3000/api';
        let syncEnabled = true; // æ˜¯å¦å¯ç”¨åŒæ­¥åŠŸèƒ½
        let lastSyncTime = localStorage.getItem('lastSyncTime') || null;

        // æ•°æ®å­˜å‚¨
        let cadres = JSON.parse(localStorage.getItem('cadres')) || [];
        let competitions = JSON.parse(localStorage.getItem('competitions')) || [];
        let contributions = JSON.parse(localStorage.getItem('contributions')) || [];
        let trainings = JSON.parse(localStorage.getItem('trainings')) || [];
        let deductions = JSON.parse(localStorage.getItem('deductions')) || [];

        // GitHubè®¾ç½®
        let githubSettings = JSON.parse(localStorage.getItem('githubSettings')) || {
            url: '',
            autoLoad: false,
            autoSync: false
        };

        // æ¨¡å¼å’Œæƒé™æ§åˆ¶
        let currentMode = 'view'; // 'view' æˆ– 'edit'
        let adminPassword = localStorage.getItem('adminPassword') || '123456';

        let radarChart = null;

        function initChart() {
            const ctx = document.getElementById('radarChart').getContext('2d');
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['éƒ¨é—¨èŒè´£', 'æ¯”èµ›æˆç»©', 'åä¼šè´¡çŒ®', 'è®¾å¤‡æŒæ§', 'æ–°ç”ŸæŒ‡å¯¼'],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 1000,
                            ticks: {
                                stepSize: 200
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
        }

        function toggleCollapsible(header) {
            const section = header.parentElement;
            section.classList.toggle('active');
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
            refreshAllTables();
        }

        function refreshAllTables() {
            updateCadreTable();
            updateCompetitionTable();
            updateContributionTable();
            updateTrainingTable();
            updateDeductionTable();
            updateOverview();
            updateDropdowns();
        }

        function updateDropdowns() {
            const options = cadres.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('competitionCadre').innerHTML = '<option value="">é€‰æ‹©å¹²éƒ¨</option>' + options;
            document.getElementById('contributionCadre').innerHTML = '<option value="">é€‰æ‹©å¹²éƒ¨</option>' + options;
            document.getElementById('trainingCadre').innerHTML = '<option value="">é€‰æ‹©å¹²éƒ¨</option>' + options;
            document.getElementById('deductionCadre').innerHTML = '<option value="">é€‰æ‹©å¹²éƒ¨</option>' + options;
        }

        function calculateCadreScore(cadreId) {
            const cadre = cadres.find(c => c.id === cadreId);
            if (!cadre) return { department: 0, competition: 0, contribution: 0, equipment: 0, training: 0, total: 0 };

            const compScore = competitions
                .filter(c => c.cadreId === cadreId)
                .reduce((sum, c) => sum + c.score, 0);

            const contribScore = contributions
                .filter(c => c.cadreId === cadreId)
                .reduce((sum, c) => sum + c.totalScore, 0);

            const trainScore = trainings
                .filter(t => t.cadreId === cadreId)
                .reduce((sum, t) => sum + t.score, 0);

            const deductionScore = deductions
                .filter(d => d.cadreId === cadreId)
                .reduce((sum, d) => sum + d.score, 0);

            const deptScore = 1000 - deductionScore;
            const equipScore = cadre.equipmentScore || 0;

            return {
                department: Math.max(0, deptScore),
                competition: compScore,
                contribution: contribScore,
                equipment: equipScore,
                training: trainScore,
                total: Math.max(0, deptScore) + compScore + contribScore + equipScore + trainScore
            };
        }

        function getLevel(total) {
            if (total >= 1800) return { text: 'ä¼˜ç§€', class: 'status-excellent' };
            if (total >= 1400) return { text: 'è‰¯å¥½', class: 'status-good' };
            if (total >= 1000) return { text: 'ä¸€èˆ¬', class: 'status-average' };
            return { text: 'å¾…æ”¹è¿›', class: 'status-poor' };
        }

        function updateOverview() {
            if (cadres.length === 0) {
                document.getElementById('totalCadres').textContent = '0';
                document.getElementById('avgScore').textContent = '0';
                document.getElementById('excellentCount').textContent = '0';
                document.getElementById('goodCount').textContent = '0';
                document.getElementById('averageCount').textContent = '0';
                document.getElementById('poorCount').textContent = '0';
                document.getElementById('overviewScores').innerHTML = '';
                document.getElementById('cadreSelection').innerHTML = '<p style="color: #999;">æš‚æ— å¹²éƒ¨æ•°æ®</p>';
                radarChart.data.datasets = [];
                radarChart.update();
                return;
            }

            let totalScore = 0;
            let excellent = 0, good = 0, average = 0, poor = 0;

            cadres.forEach(cadre => {
                const score = calculateCadreScore(cadre.id);
                totalScore += score.total;
                const level = getLevel(score.total).text;
                if (level === 'ä¼˜ç§€') excellent++;
                else if (level === 'è‰¯å¥½') good++;
                else if (level === 'ä¸€èˆ¬') average++;
                else poor++;
            });

            document.getElementById('totalCadres').textContent = cadres.length;
            document.getElementById('avgScore').textContent = (totalScore / cadres.length).toFixed(1);
            document.getElementById('excellentCount').textContent = excellent;
            document.getElementById('goodCount').textContent = good;
            document.getElementById('averageCount').textContent = average;
            document.getElementById('poorCount').textContent = poor;

            renderCadreSelection();
            updateRadarChartWithSelection();

            let deptSum = 0, compSum = 0, contribSum = 0, equipSum = 0, trainSum = 0;
            cadres.forEach(cadre => {
                const score = calculateCadreScore(cadre.id);
                deptSum += score.department;
                compSum += score.competition;
                contribSum += score.contribution;
                equipSum += score.equipment;
                trainSum += score.training;
            });

            const avg = cadres.length;
            document.getElementById('overviewScores').innerHTML = `
                <div class="score-item">
                    <div class="label">éƒ¨é—¨èŒè´£å¹³å‡</div>
                    <h3>${(deptSum / avg).toFixed(1)}</h3>
                </div>
                <div class="score-item">
                    <div class="label">æ¯”èµ›æˆç»©å¹³å‡</div>
                    <h3>${(compSum / avg).toFixed(1)}</h3>
                </div>
                <div class="score-item">
                    <div class="label">åä¼šè´¡çŒ®å¹³å‡</div>
                    <h3>${(contribSum / avg).toFixed(1)}</h3>
                </div>
                <div class="score-item">
                    <div class="label">è®¾å¤‡æŒæ§å¹³å‡</div>
                    <h3>${(equipSum / avg).toFixed(1)}</h3>
                </div>
                <div class="score-item total-score">
                    <div class="label">æ–°ç”ŸæŒ‡å¯¼å¹³å‡</div>
                    <h3>${(trainSum / avg).toFixed(1)}</h3>
                </div>
            `;
        }

        function renderCadreSelection() {
            const container = document.getElementById('cadreSelection');
            const searchTerm = document.getElementById('cadreSearch').value.toLowerCase();
            
            const filteredCadres = cadres.filter(cadre => 
                cadre.name.toLowerCase().includes(searchTerm) ||
                (cadre.department && cadre.department.toLowerCase().includes(searchTerm))
            );

            if (filteredCadres.length === 0) {
                container.innerHTML = '<p style="color: #999;">æœªæ‰¾åˆ°åŒ¹é…çš„å¹²éƒ¨</p>';
                return;
            }

            container.innerHTML = filteredCadres.map(cadre => `
                <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 5px; margin: 5px 0; transition: background 0.2s;" 
                       onmouseover="this.style.background='#f0f0f0'" 
                       onmouseout="this.style.background='transparent'">
                    <input type="checkbox" value="${cadre.id}" class="cadre-checkbox" style="margin-right: 10px; width: 18px; height: 18px;">
                    <span>${cadre.name}</span>
                    <span style="color: #999; margin-left: 10px; font-size: 0.9em;">(${cadre.department || 'æœªåˆ†é…éƒ¨é—¨'})</span>
                </label>
            `).join('');
        }

        function filterCadreOptions() {
            renderCadreSelection();
        }

        function getSelectedCadreIds() {
            const checkboxes = document.querySelectorAll('.cadre-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function updateRadarChartWithSelection() {
            const selectedIds = getSelectedCadreIds();
            
            if (selectedIds.length === 0) {
                document.getElementById('chartPlaceholder').style.display = 'block';
                radarChart.data.datasets = [];
                radarChart.update();
                return;
            }

            document.getElementById('chartPlaceholder').style.display = 'none';

            const colors = [
                { bg: 'rgba(102, 126, 234, 0.2)', border: 'rgba(102, 126, 234, 1)' },
                { bg: 'rgba(118, 75, 162, 0.2)', border: 'rgba(118, 75, 162, 1)' },
                { bg: 'rgba(40, 167, 69, 0.2)', border: 'rgba(40, 167, 69, 1)' },
                { bg: 'rgba(220, 53, 69, 0.2)', border: 'rgba(220, 53, 69, 1)' },
                { bg: 'rgba(0, 123, 255, 0.2)', border: 'rgba(0, 123, 255, 1)' },
                { bg: 'rgba(255, 193, 7, 0.2)', border: 'rgba(255, 193, 7, 1)' },
                { bg: 'rgba(23, 162, 184, 0.2)', border: 'rgba(23, 162, 184, 1)' },
                { bg: 'rgba(111, 66, 193, 0.2)', border: 'rgba(111, 66, 193, 1)' },
                { bg: 'rgba(40, 167, 69, 0.2)', border: 'rgba(40, 167, 69, 1)' },
                { bg: 'rgba(253, 126, 20, 0.2)', border: 'rgba(253, 126, 20, 1)' }
            ];

            radarChart.data.datasets = selectedIds.map((id, index) => {
                const cadre = cadres.find(c => c.id === id);
                if (!cadre) return null;
                
                const score = calculateCadreScore(cadre.id);
                return {
                    label: cadre.name,
                    data: [score.department, score.competition, score.contribution, score.equipment, score.training],
                    backgroundColor: colors[index % colors.length].bg,
                    borderColor: colors[index % colors.length].border,
                    borderWidth: 2,
                    pointBackgroundColor: colors[index % colors.length].border,
                    pointRadius: 4
                };
            }).filter(ds => ds !== null);
            
            radarChart.update();
        }

        function compareSelectedCadres() {
            const selectedIds = getSelectedCadreIds();
            
            if (selectedIds.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦å¯¹æ¯”çš„å¹²éƒ¨ï¼');
                return;
            }

            if (selectedIds.length === 1) {
                document.getElementById('chartPlaceholder').style.display = 'none';
            }

            updateRadarChartWithSelection();
        }

        function clearChartSelection() {
            const checkboxes = document.querySelectorAll('.cadre-checkbox:checked');
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('cadreSearch').value = '';
            renderCadreSelection();
            document.getElementById('chartPlaceholder').style.display = 'block';
            radarChart.data.datasets = [];
            radarChart.update();
        }

        function updateCadreTable() {
            const tbody = document.getElementById('cadreTableBody');
            tbody.innerHTML = '';

            cadres.forEach(cadre => {
                const score = calculateCadreScore(cadre.id);
                const level = getLevel(score.total);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cadre.name}</td>
                    <td>${cadre.department}</td>
                    <td>${cadre.position}</td>
                    <td>${cadre.major || '-'}</td>
                    <td>${cadre.class || '-'}</td>
                    <td>${cadre.grade || '-'}</td>
                    <td>${score.department.toFixed(1)}</td>
                    <td>${score.competition.toFixed(1)}</td>
                    <td>${score.contribution.toFixed(1)}</td>
                    <td>${score.equipment.toFixed(1)}</td>
                    <td>${score.training.toFixed(1)}</td>
                    <td style="font-weight: bold; font-size: 1.2em;">${score.total.toFixed(1)}</td>
                    <td><span class="status ${level.class}">${level.text}</span></td>
                    <td>
                        <button class="btn btn-view" onclick="viewDetail('${cadre.id}')">è¯¦æƒ…</button>
                        <button class="btn btn-edit" onclick="editCadre('${cadre.id}')">ç¼–è¾‘</button>
                        <button class="btn btn-delete" onclick="deleteCadre('${cadre.id}')">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function saveCadre() {
            const id = document.getElementById('cadreId').value || Date.now().toString();
            const cadre = {
                id: id,
                name: document.getElementById('cadreName').value,
                department: document.getElementById('cadreDepartment').value,
                position: document.getElementById('cadrePosition').value,
                major: document.getElementById('cadreMajor').value,
                class: document.getElementById('cadreClass').value,
                grade: document.getElementById('cadreGrade').value,
                equipmentScore: 0
            };

            const existingIndex = cadres.findIndex(c => c.id === id);
            if (existingIndex >= 0) {
                cadres[existingIndex] = { ...cadres[existingIndex], ...cadre };
            } else {
                cadres.push(cadre);
            }

            localStorage.setItem('cadres', JSON.stringify(cadres));
            refreshAllTables();
            resetCadreForm();
            alert('ä¿å­˜æˆåŠŸï¼');
        }

        function editCadre(id) {
            const cadre = cadres.find(c => c.id === id);
            if (cadre) {
                document.getElementById('cadreId').value = cadre.id;
                document.getElementById('cadreName').value = cadre.name || '';
                document.getElementById('cadreDepartment').value = cadre.department || '';
                document.getElementById('cadrePosition').value = cadre.position || '';
                document.getElementById('cadreMajor').value = cadre.major || '';
                document.getElementById('cadreClass').value = cadre.class || '';
                document.getElementById('cadreGrade').value = cadre.grade || '';
            }
        }

        function deleteCadre(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥å¹²éƒ¨å—ï¼Ÿ')) {
                cadres = cadres.filter(c => c.id !== id);
                competitions = competitions.filter(c => c.cadreId !== id);
                contributions = contributions.filter(c => c.cadreId !== id);
                trainings = trainings.filter(t => t.cadreId !== id);
                deductions = deductions.filter(d => d.cadreId !== id);
                saveAllData();
                refreshAllTables();
            }
        }

        function resetCadreForm() {
            document.getElementById('cadreId').value = '';
            document.getElementById('cadreName').value = '';
            document.getElementById('cadreDepartment').value = '';
            document.getElementById('cadrePosition').value = '';
            document.getElementById('cadreMajor').value = '';
            document.getElementById('cadreClass').value = '';
            document.getElementById('cadreGrade').value = '';
        }

        function viewDetail(id) {
            const cadre = cadres.find(c => c.id === id);
            if (!cadre) return;

            const score = calculateCadreScore(id);
            const comps = competitions.filter(c => c.cadreId === id);
            const contribs = contributions.filter(c => c.cadreId === id);
            const trains = trainings.filter(t => t.cadreId === id);
            const deducs = deductions.filter(d => d.cadreId === id);

            document.getElementById('modalTitle').textContent = `${cadre.name} - è€ƒæ ¸è¯¦æƒ…`;
            document.getElementById('modalContent').innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <h4>åŸºæœ¬ä¿¡æ¯</h4>
                        <p>éƒ¨é—¨: ${cadre.department}</p>
                        <p>èŒåŠ¡: ${cadre.position}</p>
                        <p>ä¸“ä¸š: ${cadre.major || '-'}</p>
                        <p>ç­çº§: ${cadre.class || '-'}</p>
                        <p>çº§æ•°: ${cadre.grade || '-'}</p>
                    </div>
                    <div class="detail-item">
                        <h4>éƒ¨é—¨èŒè´£</h4>
                        <p style="font-size: 2em; font-weight: bold; color: #667eea;">${score.department.toFixed(1)}</p>
                        <p>æ‰£åˆ†: ${deducs.reduce((s, d) => s + d.score, 0).toFixed(1)}</p>
                    </div>
                    <div class="detail-item">
                        <h4>æ¯”èµ›æˆç»©</h4>
                        <p style="font-size: 2em; font-weight: bold; color: #28a745;">${score.competition.toFixed(1)}</p>
                        <p>è·å¥–æ¬¡æ•°: ${comps.length}</p>
                    </div>
                    <div class="detail-item">
                        <h4>åä¼šè´¡çŒ®</h4>
                        <p style="font-size: 2em; font-weight: bold; color: #17a2b8;">${score.contribution.toFixed(1)}</p>
                    </div>
                    <div class="detail-item">
                        <h4>è®¾å¤‡æŒæ§</h4>
                        <p style="font-size: 2em; font-weight: bold; color: #ffc107;">${score.equipment.toFixed(1)}</p>
                    </div>
                    <div class="detail-item">
                        <h4>æ–°ç”ŸæŒ‡å¯¼</h4>
                        <p style="font-size: 2em; font-weight: bold; color: #dc3545;">${score.training.toFixed(1)}</p>
                    </div>
                </div>
                <h3 style="margin: 20px 0;">æ€»åˆ†: ${score.total.toFixed(1)} - ${getLevel(score.total).text}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>æ¯”èµ›è®°å½•</h4>
                        <div class="record-list">
                            ${comps.map(c => `<div class="record-item">
                                <span>${c.name} - ${c.level} ${c.award}</span>
                                <span class="score-change score-plus">+${c.score}</span>
                            </div>`).join('') || '<p>æš‚æ— è®°å½•</p>'}
                        </div>
                    </div>
                    <div>
                        <h4>æ‰£åˆ†è®°å½•</h4>
                        <div class="record-list">
                            ${deducs.map(d => `<div class="record-item">
                                <span>${d.reason}</span>
                                <span class="score-change score-minus">-${d.score}</span>
                            </div>`).join('') || '<p>æš‚æ— è®°å½•</p>'}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('detailModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // æ¨¡å¼å’Œæƒé™æ§åˆ¶å‡½æ•°
        function promptPassword() {
            const password = prompt('è¯·è¾“å…¥ç¼–è¾‘æ¨¡å¼å¯†ç ï¼š');
            if (password === adminPassword) {
                switchToEditMode();
            } else if (password !== null) {
                alert('å¯†ç é”™è¯¯ï¼');
            }
        }

        function switchToEditMode() {
            currentMode = 'edit';
            updateModeControls();
            enableEditControls();
            alert('å·²åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼ï¼');
        }

        function switchToViewMode() {
            currentMode = 'view';
            updateModeControls();
            disableEditControls();
            alert('å·²åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼ï¼');
        }

        function updateModeControls() {
            const modeIndicator = document.getElementById('modeIndicator');
            const switchModeBtn = document.getElementById('switchModeBtn');
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            const clearDataBtn = document.getElementById('clearDataBtn');

            if (currentMode === 'edit') {
                modeIndicator.textContent = 'ç¼–è¾‘æ¨¡å¼';
                modeIndicator.style.color = '#dc3545';
                switchModeBtn.textContent = 'åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼';
                switchModeBtn.onclick = switchToViewMode;
                changePasswordBtn.style.display = 'inline-block';
                clearDataBtn.style.display = 'inline-block';
            } else {
                modeIndicator.textContent = 'æŸ¥çœ‹æ¨¡å¼';
                modeIndicator.style.color = '#28a745';
                switchModeBtn.textContent = 'åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼';
                switchModeBtn.onclick = promptPassword;
                changePasswordBtn.style.display = 'none';
                clearDataBtn.style.display = 'none';
            }
        }

        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'block';
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
            // æ¸…ç©ºè¡¨å•
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function changePassword() {
            const currentPwd = document.getElementById('currentPassword').value;
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmPassword').value;

            if (currentPwd !== adminPassword) {
                alert('å½“å‰å¯†ç é”™è¯¯ï¼');
                return;
            }

            if (newPwd !== confirmPwd) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´ï¼');
                return;
            }

            if (newPwd.length < 6) {
                alert('æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½ï¼');
                return;
            }

            adminPassword = newPwd;
            localStorage.setItem('adminPassword', adminPassword);
            
            // å¦‚æœå¯ç”¨äº†åŒæ­¥ï¼Œä¹Ÿæ›´æ–°æœåŠ¡å™¨ä¸Šçš„å¯†ç 
            if (syncEnabled) {
                updateServerPassword(adminPassword);
            }
            
            closeChangePasswordModal();
            alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
        }

        // æ›´æ–°æœåŠ¡å™¨å¯†ç 
        async function updateServerPassword(password) {
            if (!syncEnabled) return;
            
            try {
                const response = await fetch(`${SERVER_URL}/settings/password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });
                
                if (!response.ok) {
                    throw new Error('æ›´æ–°æœåŠ¡å™¨å¯†ç å¤±è´¥');
                }
                
                console.log('æœåŠ¡å™¨å¯†ç æ›´æ–°æˆåŠŸ');
            } catch (error) {
                console.error('æ›´æ–°æœåŠ¡å™¨å¯†ç é”™è¯¯:', error.message);
            }
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®åŠŸèƒ½
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç”¨æˆ·æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                // æ¸…é™¤æ‰€æœ‰localStorageæ•°æ®
                localStorage.removeItem('cadres');
                localStorage.removeItem('competitions');
                localStorage.removeItem('contributions');
                localStorage.removeItem('trainings');
                localStorage.removeItem('deductions');
                localStorage.removeItem('lastSyncTime');
                
                // é‡ç½®å†…å­˜ä¸­çš„æ•°æ®
                cadres = [];
                competitions = [];
                contributions = [];
                trainings = [];
                deductions = [];
                
                // åˆ·æ–°æ‰€æœ‰è¡¨æ ¼
                refreshAllTables();
                
                // é‡ç½®å›¾è¡¨
                radarChart.data.datasets = [];
                radarChart.update();
                document.getElementById('chartPlaceholder').style.display = 'block';
                
                // å¦‚æœå¯ç”¨äº†åŒæ­¥ï¼Œä¹Ÿæ¸…é™¤æœåŠ¡å™¨ä¸Šçš„æ•°æ®
                if (syncEnabled) {
                    clearServerData();
                }
                
                alert('æ‰€æœ‰ç”¨æˆ·æ•°æ®å·²æ¸…é™¤ï¼');
            }
        }

        // æ•°æ®åŒæ­¥åŠŸèƒ½
        
        // ä»æœåŠ¡å™¨ä¸‹è½½æ•°æ®
        async function syncFromServer() {
            if (!syncEnabled) return;
            
            try {
                const response = await fetch(`${SERVER_URL}/sync/all`);
                if (!response.ok) {
                    throw new Error('æœåŠ¡å™¨å“åº”é”™è¯¯');
                }
                
                const data = await response.json();
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                cadres = data.cadres || [];
                competitions = data.competitions || [];
                contributions = data.contributions || [];
                trainings = data.trainings || [];
                deductions = data.deductions || [];
                
                // ä¿å­˜åˆ°localStorage
                saveAllData();
                
                // æ›´æ–°åŒæ­¥æ—¶é—´
                lastSyncTime = new Date().toISOString();
                localStorage.setItem('lastSyncTime', lastSyncTime);
                
                // åˆ·æ–°ç•Œé¢
                refreshAllTables();
                
                console.log('æ•°æ®ä»æœåŠ¡å™¨åŒæ­¥æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('ä»æœåŠ¡å™¨åŒæ­¥æ•°æ®å¤±è´¥:', error.message);
                return false;
            }
        }

        // ä¸Šä¼ æ•°æ®åˆ°æœåŠ¡å™¨
        async function syncToServer() {
            if (!syncEnabled) return;
            
            try {
                const response = await fetch(`${SERVER_URL}/sync/upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cadres,
                        competitions,
                        contributions,
                        trainings,
                        deductions
                    })
                });
                
                if (!response.ok) {
                    throw new Error('æœåŠ¡å™¨å“åº”é”™è¯¯');
                }
                
                // æ›´æ–°åŒæ­¥æ—¶é—´
                lastSyncTime = new Date().toISOString();
                localStorage.setItem('lastSyncTime', lastSyncTime);
                
                console.log('æ•°æ®ä¸Šä¼ åˆ°æœåŠ¡å™¨æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('ä¸Šä¼ æ•°æ®åˆ°æœåŠ¡å™¨å¤±è´¥:', error.message);
                return false;
            }
        }

        // è‡ªåŠ¨åŒæ­¥ï¼ˆå…ˆä¸Šä¼ æœ¬åœ°ä¿®æ”¹ï¼Œå†ä¸‹è½½æœåŠ¡å™¨æ•°æ®ï¼‰
        function startAutoSync() {
            // æ¯5åˆ†é’ŸåŒæ­¥ä¸€æ¬¡
            setInterval(async () => {
                if (syncEnabled) {
                    // å…ˆä¸Šä¼ æœ¬åœ°ä¿®æ”¹ï¼Œå†ä¸‹è½½æœåŠ¡å™¨æ•°æ®ï¼ˆä¸æ‰‹åŠ¨åŒæ­¥é€»è¾‘ä¸€è‡´ï¼‰
                    await syncToServer();
                    await syncFromServer();
                }
            }, 5 * 60 * 1000);
        }

        // æ‰‹åŠ¨åŒæ­¥ï¼ˆå…ˆä¸Šä¼ æœ¬åœ°ä¿®æ”¹ï¼Œå†ä¸‹è½½æœåŠ¡å™¨æœ€æ–°æ•°æ®ï¼‰
        async function manualSync() {
            try {
                // å…ˆä¸Šä¼ æœ¬åœ°ä¿®æ”¹
                const uploadSuccess = await syncToServer();
                if (uploadSuccess) {
                    // å†ä¸‹è½½æœåŠ¡å™¨æœ€æ–°æ•°æ®
                    const downloadSuccess = await syncFromServer();
                    if (downloadSuccess) {
                        alert('æ•°æ®åŒæ­¥å®Œæˆï¼');
                        return true;
                    }
                }
                alert('æ•°æ®åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æœåŠ¡å™¨çŠ¶æ€');
                return false;
            } catch (error) {
                console.error('æ‰‹åŠ¨åŒæ­¥å¤±è´¥:', error);
                alert('æ•°æ®åŒæ­¥å¤±è´¥ï¼š' + error.message);
                return false;
            }
        }

        // æ¸…é™¤æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰æ•°æ®
        async function clearServerData() {
            if (!syncEnabled) return;
            
            try {
                const response = await fetch(`${SERVER_URL}/sync/clear`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('æœåŠ¡å™¨å“åº”é”™è¯¯');
                }
                
                console.log('æœåŠ¡å™¨æ•°æ®æ¸…é™¤æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('æ¸…é™¤æœåŠ¡å™¨æ•°æ®å¤±è´¥:', error.message);
                return false;
            }
        }

        // æ£€æŸ¥æœåŠ¡å™¨è¿æ¥çŠ¶æ€
        async function checkServerStatus() {
            try {
                const response = await fetch(`${SERVER_URL}/cadres`);
                return response.ok;
            } catch (error) {
                return false;
            }
        }
        
        // å°†å¸¸ç”¨å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œæ–¹ä¾¿æ§åˆ¶å°è°ƒè¯•
        window.checkServerStatus = checkServerStatus;
        window.manualSync = manualSync;
        window.syncEnabled = syncEnabled;
        window.SERVER_URL = SERVER_URL;

        function enableEditControls() {
            // å¯ç”¨æ‰€æœ‰ç¼–è¾‘æŒ‰é’®
            document.querySelectorAll('.btn-add, .btn-submit, .btn-edit, .btn-delete, #clearDataBtn').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });

            // å¯ç”¨è¡¨å•è¾“å…¥
            document.querySelectorAll('input, select, textarea').forEach(input => {
                if (!input.hasAttribute('readonly')) {
                    input.disabled = false;
                }
            });
        }

        function disableEditControls() {
            // ç¦ç”¨æ‰€æœ‰ç¼–è¾‘æŒ‰é’®
            document.querySelectorAll('.btn-add, .btn-submit, .btn-edit, .btn-delete, #clearDataBtn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });

            // ç¦ç”¨è¡¨å•è¾“å…¥
            document.querySelectorAll('input, select, textarea').forEach(input => {
                if (!input.hasAttribute('readonly')) {
                    input.disabled = true;
                }
            });
        }

        function searchCadres() {
            const keyword = document.getElementById('searchCadre').value.toLowerCase();
            const rows = document.querySelectorAll('#cadreTableBody tr');
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(keyword) ? '' : 'none';
            });
        }

        function addCompetition() {
            const cadreId = document.getElementById('competitionCadre').value;
            const level = document.getElementById('competitionLevel').value;
            const award = document.getElementById('competitionAward').value;
            const name = document.getElementById('competitionName').value;

            if (!cadreId || !level || !award) {
                alert('è¯·é€‰æ‹©å¹²éƒ¨ã€æ¯”èµ›çº§åˆ«å’Œå¥–é¡¹ï¼');
                return;
            }

            let score = 0;
            if (level === 'å›½å®¶çº§') {
                score = award === 'ä¸€ç­‰å¥–' ? 300 : award === 'äºŒç­‰å¥–' ? 250 : 200;
            } else if (level === 'çœçº§') {
                score = award === 'ä¸€ç­‰å¥–' ? 150 : award === 'äºŒç­‰å¥–' ? 100 : 50;
            } else {
                score = award === 'ä¸€ç­‰å¥–' ? 20 : award === 'äºŒç­‰å¥–' ? 10 : 5;
            }

            competitions.push({
                id: Date.now(),
                cadreId,
                name,
                level,
                award,
                score
            });

            localStorage.setItem('competitions', JSON.stringify(competitions));
            updateCompetitionTable();
            updateOverview();
            alert(`æ·»åŠ æˆåŠŸï¼+${score}åˆ†`);
        }

        function updateCompetitionTable() {
            const tbody = document.getElementById('competitionTableBody');
            tbody.innerHTML = '';
            competitions.forEach((comp, index) => {
                const cadre = cadres.find(c => c.id === comp.cadreId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cadre ? cadre.name : 'æœªçŸ¥'}</td>
                    <td>${comp.name}</td>
                    <td>${comp.level}</td>
                    <td>${comp.award}</td>
                    <td style="color: #28a745; font-weight: bold;">+${comp.score}</td>
                    <td><button class="btn btn-delete" onclick="deleteCompetition(${index})">åˆ é™¤</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function deleteCompetition(index) {
            competitions.splice(index, 1);
            localStorage.setItem('competitions', JSON.stringify(competitions));
            updateCompetitionTable();
            updateOverview();
        }

        function addContribution() {
            const cadreId = document.getElementById('contributionCadre').value;
            const type = document.getElementById('contributionType').value;
            const count = parseInt(document.getElementById('contributionCount').value) || 1;

            if (!cadreId || !type) {
                alert('è¯·é€‰æ‹©å¹²éƒ¨å’Œè´¡çŒ®ç±»å‹ï¼');
                return;
            }

            const totalScore = count * 0.1;
            contributions.push({
                id: Date.now(),
                cadreId,
                type,
                count,
                totalScore
            });

            localStorage.setItem('contributions', JSON.stringify(contributions));
            updateContributionTable();
            updateOverview();
            alert(`æ·»åŠ æˆåŠŸï¼+${totalScore}åˆ†`);
        }

        function updateContributionTable() {
            const tbody = document.getElementById('contributionTableBody');
            tbody.innerHTML = '';
            contributions.forEach((contrib, index) => {
                const cadre = cadres.find(c => c.id === contrib.cadreId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cadre ? cadre.name : 'æœªçŸ¥'}</td>
                    <td>${contrib.type}</td>
                    <td>${contrib.count}</td>
                    <td style="color: #28a745; font-weight: bold;">+${contrib.totalScore.toFixed(1)}</td>
                    <td><button class="btn btn-delete" onclick="deleteContribution(${index})">åˆ é™¤</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function deleteContribution(index) {
            contributions.splice(index, 1);
            localStorage.setItem('contributions', JSON.stringify(contributions));
            updateContributionTable();
            updateOverview();
        }

        function importExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                let importCount = 0;
                const tbody = document.getElementById('equipmentTableBody');
                tbody.innerHTML = '';

                jsonData.forEach(row => {
                    const name = row['å§“å'] || row['name'] || Object.values(row)[0];
                    const score = row['åˆ†æ•°'] || row['score'] || row['è®¾å¤‡æŒæ§'] || Object.values(row)[1];

                    if (name && score !== undefined) {
                        const convertedScore = (parseFloat(score) / 100) * 1000;
                        const cadre = cadres.find(c => c.name === name);
                        if (cadre) {
                            cadre.equipmentScore = convertedScore;
                        }

                        importCount++;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${name}</td>
                            <td>${score}</td>
                            <td style="color: #667eea; font-weight: bold;">${convertedScore.toFixed(1)}</td>
                            <td>${cadre ? 'å·²æ›´æ–°' : 'æœªæ‰¾åˆ°å¹²éƒ¨'}</td>
                        `;
                        tbody.appendChild(tr);
                    }
                });

                localStorage.setItem('cadres', JSON.stringify(cadres));
                document.getElementById('importResult').innerHTML = `<p style="color: #28a745;">âœ… æˆåŠŸå¯¼å…¥ ${importCount} æ¡è®°å½•</p>`;
                updateOverview();
            };
            reader.readAsArrayBuffer(file);
        }

        function updateEquipmentTable() {
            const tbody = document.getElementById('equipmentTableBody');
            tbody.innerHTML = '';
            cadres.forEach(cadre => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cadre.name}</td>
                    <td>-</td>
                    <td style="color: #667eea; font-weight: bold;">${(cadre.equipmentScore || 0).toFixed(1)}</td>
                    <td><button class="btn btn-edit" onclick="updateEquipmentManual('${cadre.id}')">æ‰‹åŠ¨è®¾ç½®</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateEquipmentManual(id) {
            const cadre = cadres.find(c => c.id === id);
            if (cadre) {
                const score = prompt(`è¯·è¾“å…¥${cadre.name}çš„è®¾å¤‡æŒæ§åˆ†æ•°ï¼ˆ0-100ï¼‰:`, cadre.equipmentScore ? cadre.equipmentScore / 10 : 0);
                if (score !== null) {
                    cadre.equipmentScore = (parseFloat(score) || 0) * 10;
                    localStorage.setItem('cadres', JSON.stringify(cadres));
                    updateEquipmentTable();
                    updateOverview();
                }
            }
        }

        function addTraining() {
            const cadreId = document.getElementById('trainingCadre').value;
            const traineeName = document.getElementById('traineeName').value;
            const hours = parseFloat(document.getElementById('trainingHours').value) || 0;

            if (!cadreId || !traineeName || hours <= 0) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼');
                return;
            }

            const score = hours * 0.5;
            trainings.push({
                id: Date.now(),
                cadreId,
                traineeName,
                hours,
                score
            });

            localStorage.setItem('trainings', JSON.stringify(trainings));
            updateTrainingTable();
            updateOverview();
            alert(`æ·»åŠ æˆåŠŸï¼+${score}åˆ†`);
        }

        function updateTrainingTable() {
            const tbody = document.getElementById('trainingTableBody');
            tbody.innerHTML = '';
            trainings.forEach((train, index) => {
                const cadre = cadres.find(c => c.id === train.cadreId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cadre ? cadre.name : 'æœªçŸ¥'}</td>
                    <td>${train.traineeName}</td>
                    <td>${train.hours}</td>
                    <td style="color: #28a745; font-weight: bold;">+${train.score.toFixed(1)}</td>
                    <td><button class="btn btn-delete" onclick="deleteTraining(${index})">åˆ é™¤</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function deleteTraining(index) {
            trainings.splice(index, 1);
            localStorage.setItem('trainings', JSON.stringify(trainings));
            updateTrainingTable();
            updateOverview();
        }

        function addDeduction() {
            const cadreId = document.getElementById('deductionCadre').value;
            const score = parseFloat(document.getElementById('deductionScore').value) || 0;
            const reason = document.getElementById('deductionReason').value;

            if (!cadreId || score <= 0) {
                alert('è¯·é€‰æ‹©å¹²éƒ¨å¹¶è¾“å…¥æ‰£åˆ†åˆ†æ•°ï¼');
                return;
            }

            deductions.push({
                id: Date.now(),
                cadreId,
                score,
                reason
            });

            localStorage.setItem('deductions', JSON.stringify(deductions));
            updateDeductionTable();
            updateOverview();
            alert(`æ‰£åˆ†æˆåŠŸï¼-${score}åˆ†`);
        }

        function updateDeductionTable() {
            const tbody = document.getElementById('deductionTableBody');
            tbody.innerHTML = '';
            deductions.forEach((ded, index) => {
                const cadre = cadres.find(c => c.id === ded.cadreId);
                const currentScore = calculateCadreScore(ded.cadreId).department;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cadre ? cadre.name : 'æœªçŸ¥'}</td>
                    <td>${ded.reason || 'æœªè¯´æ˜åŸå› '}</td>
                    <td style="color: #dc3545; font-weight: bold;">-${ded.score}</td>
                    <td>${currentScore.toFixed(1)}</td>
                    <td><button class="btn btn-delete" onclick="deleteDeduction(${index})">åˆ é™¤</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function deleteDeduction(index) {
            deductions.splice(index, 1);
            localStorage.setItem('deductions', JSON.stringify(deductions));
            updateDeductionTable();
            updateOverview();
        }

        function importExcelData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        alert('Excelæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®ï¼');
                        return;
                    }

                    let successCount = 0;
                    const requiredFields = ['å§“å', 'éƒ¨é—¨'];

                    jsonData.forEach(row => {
                        const missingFields = requiredFields.filter(field => !row[field]);
                        if (missingFields.length > 0) {
                            console.warn(`ç¼ºå°‘å¿…è¦å­—æ®µ: ${missingFields.join(', ')}`);
                            return;
                        }

                        const cadre = {
                            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                            name: row['å§“å'] || '',
                            department: row['éƒ¨é—¨'] || '',
                            position: row['èŒåŠ¡'] || '',
                            major: row['ä¸“ä¸š'] || '',
                            class: row['ç­çº§'] || '',
                            grade: row['çº§æ•°'] || '',
                            equipmentScore: 0
                        };

                        cadres.push(cadre);
                        successCount++;
                    });

                    localStorage.setItem('cadres', JSON.stringify(cadres));
                    refreshAllTables();
                    input.value = '';
                    
                    if (successCount > 0) {
                        alert(`æˆåŠŸå¯¼å…¥ ${successCount} æ¡å¹²éƒ¨æ•°æ®ï¼`);
                    } else {
                        alert('æœªèƒ½å¯¼å…¥ä»»ä½•æ•°æ®ï¼Œè¯·æ£€æŸ¥Excelæ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚\nå¿…è¦å­—æ®µï¼šå§“åã€éƒ¨é—¨\nå¯é€‰å­—æ®µï¼šèŒåŠ¡ã€ä¸“ä¸šã€ç­çº§ã€çº§æ•°');
                    }
                } catch (error) {
                    console.error('å¯¼å…¥é”™è¯¯:', error);
                    alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·ç¡®ä¿Excelæ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function downloadExcelTemplate() {
            const templateData = [
                {
                    'å§“å': 'ç¤ºä¾‹ï¼šå¼ ä¸‰',
                    'éƒ¨é—¨': 'èµ›äº‹éƒ¨',
                    'èŒåŠ¡': 'éƒ¨é•¿',
                    'ä¸“ä¸š': 'è®¡ç®—æœºç§‘å­¦',
                    'ç­çº§': '1ç­',
                    'çº§æ•°': '2024çº§'
                },
                {
                    'å§“å': 'ç¤ºä¾‹ï¼šæå››',
                    'éƒ¨é—¨': 'AIéƒ¨',
                    'èŒåŠ¡': 'å‰¯ä¼šé•¿',
                    'ä¸“ä¸š': 'äººå·¥æ™ºèƒ½',
                    'ç­çº§': '2ç­',
                    'çº§æ•°': '2024çº§'
                }
            ];

            const ws = XLSX.utils.json_to_sheet(templateData);
            const wsCols = [
                { wch: 15 },
                { wch: 12 },
                { wch: 10 },
                { wch: 15 },
                { wch: 10 },
                { wch: 10 }
            ];
            ws['!cols'] = wsCols;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'å¹²éƒ¨ä¿¡æ¯');

            XLSX.writeFile(wb, 'å¹²éƒ¨ä¿¡æ¯å¯¼å…¥æ¨¡æ¿.xlsx');
        }

        function exportData() {
            let csv = 'å§“å,éƒ¨é—¨,èŒåŠ¡,ä¸“ä¸š,ç­çº§,çº§æ•°,éƒ¨é—¨èŒè´£,æ¯”èµ›æˆç»©,åä¼šè´¡çŒ®,è®¾å¤‡æŒæ§,æ–°ç”ŸæŒ‡å¯¼,æ€»åˆ†,ç­‰çº§\n';
            cadres.forEach(cadre => {
                const score = calculateCadreScore(cadre.id);
                const level = getLevel(score.total).text;
                csv += `${cadre.name},${cadre.department},${cadre.position},${cadre.major || ''},${cadre.class || ''},${cadre.grade || ''},${score.department.toFixed(1)},${score.competition.toFixed(1)},${score.contribution.toFixed(1)},${score.equipment.toFixed(1)},${score.training.toFixed(1)},${score.total.toFixed(1)},${level}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'å¹²éƒ¨è€ƒæ ¸æ•°æ®.csv';
            link.click();
        }

        function exportCompleteData() {
            const completeData = {
                cadres,
                competitions,
                contributions,
                trainings,
                deductions,
                metadata: {
                    exportDate: new Date().toISOString(),
                    version: '1.0',
                    cadreCount: cadres.length,
                    competitionCount: competitions.length,
                    contributionCount: contributions.length,
                    trainingCount: trainings.length,
                    deductionCount: deductions.length
                }
            };

            const blob = new Blob([JSON.stringify(completeData, null, 2)], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'å¹²éƒ¨è€ƒæ ¸å®Œæ•´æ•°æ®.json';
            link.click();
        }

        function importJsonData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.cadres) {
                        cadres = data.cadres;
                    }
                    if (data.competitions) {
                        competitions = data.competitions;
                    }
                    if (data.contributions) {
                        contributions = data.contributions;
                    }
                    if (data.trainings) {
                        trainings = data.trainings;
                    }
                    if (data.deductions) {
                        deductions = data.deductions;
                    }

                    saveAllData();
                    refreshAllTables();
                    alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    
                    // é‡ç½®æ–‡ä»¶è¾“å…¥
                    input.value = '';
                } catch (error) {
                    alert('æ•°æ®å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                }
            };
            reader.readAsText(file, 'utf-8');
        }

        function loadFromGitHub() {
            const githubUrl = prompt('è¯·è¾“å…¥GitHubä»“åº“ä¸­JSONæ–‡ä»¶çš„åŸå§‹URLï¼š\nä¾‹å¦‚ï¼šhttps://raw.githubusercontent.com/username/repo/main/å¹²éƒ¨è€ƒæ ¸å®Œæ•´æ•°æ®.json');
            
            if (!githubUrl) return;

            fetch(githubUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.cadres) {
                        cadres = data.cadres;
                    }
                    if (data.competitions) {
                        competitions = data.competitions;
                    }
                    if (data.contributions) {
                        contributions = data.contributions;
                    }
                    if (data.trainings) {
                        trainings = data.trainings;
                    }
                    if (data.deductions) {
                        deductions = data.deductions;
                    }

                    saveAllData();
                    refreshAllTables();
                    alert('ä»GitHubåŠ è½½æ•°æ®æˆåŠŸï¼');
                })
                .catch(error => {
                    alert('ä»GitHubåŠ è½½æ•°æ®å¤±è´¥ï¼š' + error.message);
                });
        }

        function showGithubSettings() {
            const modal = document.getElementById('githubSettingsModal');
            const githubUrlInput = document.getElementById('githubUrl');
            const autoLoadCheckbox = document.getElementById('autoLoadGithub');
            const autoSyncCheckbox = document.getElementById('autoSyncGithub');

            // å¡«å……å½“å‰è®¾ç½®
            githubUrlInput.value = githubSettings.url;
            autoLoadCheckbox.checked = githubSettings.autoLoad;
            autoSyncCheckbox.checked = githubSettings.autoSync;

            modal.style.display = 'block';
        }

        function closeGithubSettingsModal() {
            document.getElementById('githubSettingsModal').style.display = 'none';
        }

        function saveGithubSettings() {
            const githubUrlInput = document.getElementById('githubUrl');
            const autoLoadCheckbox = document.getElementById('autoLoadGithub');
            const autoSyncCheckbox = document.getElementById('autoSyncGithub');

            githubSettings = {
                url: githubUrlInput.value,
                autoLoad: autoLoadCheckbox.checked,
                autoSync: autoSyncCheckbox.checked
            };

            localStorage.setItem('githubSettings', JSON.stringify(githubSettings));
            
            // å¦‚æœå¯ç”¨äº†å®šæœŸåŒæ­¥ï¼Œé‡å¯åŒæ­¥è®¡æ—¶å™¨
            if (githubSettings.autoSync) {
                startGithubSync();
            }

            alert('GitHubè®¾ç½®ä¿å­˜æˆåŠŸï¼');
            closeGithubSettingsModal();
        }

        async function autoLoadFromGithub() {
            if (githubSettings.autoLoad && githubSettings.url) {
                try {
                    const response = await fetch(githubSettings.url);
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.cadres) {
                            cadres = data.cadres;
                        }
                        if (data.competitions) {
                            competitions = data.competitions;
                        }
                        if (data.contributions) {
                            contributions = data.contributions;
                        }
                        if (data.trainings) {
                            trainings = data.trainings;
                        }
                        if (data.deductions) {
                            deductions = data.deductions;
                        }

                        saveAllData();
                        refreshAllTables();
                        console.log('ä»GitHubè‡ªåŠ¨åŠ è½½æ•°æ®æˆåŠŸ');
                    }
                } catch (error) {
                    console.error('ä»GitHubè‡ªåŠ¨åŠ è½½æ•°æ®å¤±è´¥ï¼š', error.message);
                }
            }
        }

        function startGithubSync() {
            // æ¸…é™¤ç°æœ‰çš„åŒæ­¥è®¡æ—¶å™¨
            if (window.githubSyncInterval) {
                clearInterval(window.githubSyncInterval);
            }

            // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨åŒæ­¥ï¼Œè®¾ç½®æ–°çš„è®¡æ—¶å™¨
            if (githubSettings.autoSync && githubSettings.url) {
                window.githubSyncInterval = setInterval(async () => {
                    await autoLoadFromGithub();
                }, 5 * 60 * 1000); // æ¯5åˆ†é’ŸåŒæ­¥ä¸€æ¬¡
            }
        }

        function saveAllData() {
            localStorage.setItem('cadres', JSON.stringify(cadres));
            localStorage.setItem('competitions', JSON.stringify(competitions));
            localStorage.setItem('contributions', JSON.stringify(contributions));
            localStorage.setItem('trainings', JSON.stringify(trainings));
            localStorage.setItem('deductions', JSON.stringify(deductions));
            
            // å¦‚æœå¯ç”¨äº†åŒæ­¥ï¼Œè‡ªåŠ¨ä¸Šä¼ åˆ°æœåŠ¡å™¨
            if (syncEnabled) {
                syncToServer();
            }
        }

        window.onclick = function(event) {
            const detailModal = document.getElementById('detailModal');
            const passwordModal = document.getElementById('changePasswordModal');
            const githubModal = document.getElementById('githubSettingsModal');
            
            if (event.target == detailModal) {
                closeModal();
            } else if (event.target == passwordModal) {
                closeChangePasswordModal();
            } else if (event.target == githubModal) {
                closeGithubSettingsModal();
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            refreshAllTables();
            // åˆå§‹åŒ–æ¨¡å¼æ§åˆ¶
            updateModeControls();
            disableEditControls();
            
            // è‡ªåŠ¨ä»GitHubåŠ è½½æ•°æ®
            autoLoadFromGithub();
            
            // å¯åŠ¨GitHubåŒæ­¥
            if (githubSettings.autoSync) {
                startGithubSync();
            }
            
            // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€å¹¶åŒæ­¥æ•°æ®
            (async function() {
                const isConnected = await checkServerStatus();
                if (isConnected) {
                    // æœåŠ¡å™¨è¿æ¥æ­£å¸¸ï¼ŒåŒæ­¥æ•°æ®
                    console.log('æœåŠ¡å™¨è¿æ¥æ­£å¸¸ï¼Œå¼€å§‹åŒæ­¥æ•°æ®...');
                    await syncFromServer();
                    // å¯åŠ¨è‡ªåŠ¨åŒæ­¥
                    startAutoSync();
                } else {
                    console.log('æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
                }
            })();
        });
    </script>
</body>
</html>
